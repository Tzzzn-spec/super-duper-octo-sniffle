# 产品需求文档（PRD）

版本：v0.1（草案）
撰写人：darling（营养系）
产品名：西藏农牧区藏族居民膳食营养分析系统
目标发布日期：MVP 两周；V1.0 四周（见里程碑）

---

## 1. 背景与问题陈述

* **背景**：项目旨在服务西藏农牧区人群的膳食与营养研究，整合 FFQ、三天24小时回顾（24h）、DR-24 问卷与线下数据，完成数据录入、处理、合并、营养素计算与可视化展示。
* **痛点**：

  1. 数据文件格式不统一、跨批次合并繁琐；
  2. 计算口径分散（FFQ/DR/24h），人工处理耗时易错；
  3. 研究团队协作缺乏统一“数据—分析—可视化”闭环；
  4. 对外传播与对内管理（问卷）缺少统一入口。
* **愿景**：一站式平台——“**上传→合并→计算→可视化**”，并可被互联网索引检索（SEO）。

## 2. 目标与KPI

* **业务目标**

  * T0：研究团队内部稳定使用；T1：对外可访问与收录（Render/域名/SEO）。
* **关键指标（KPI）**

  * ≥95% 上传成功率（单/多文件）；
  * 计算耗时：单文件 < 10s，多文件（50 份）< 60s；
  * 数据合并出错率 < 2%（以自动校验+日志衡量）；
  * 下载完成率 ≥ 98%；
  * 每次发布后严重故障（P1）= 0。

## 3. 用户画像 & 使用场景

* **画像**

  * 调研员：负责现场或电话回访与问卷录入；
  * 数据分析员：批量合并、营养素计算、导出报告；
  * 项目负责人：看关键指标与可视化面板；
  * 受试者（可选）：在线填写 DR-24 / Full-FFQ 离线页面（iframe）。
* **核心路径**

  1. 进入首页 → 选择模块；
  2. 上传文件（单/多） → 服务端校验 → 处理 → 下载结果；
  3. 查看可视化 → 导出图表/数据；
  4. 问卷入口 → 嵌入离线表单（隔离样式，独立路由）。

## 4. 范围（Scope）

### 4.1 In Scope（MVP 必做）

* **数据录入**：上传 Excel（.xlsx），保存到 `uploads/`，可按需入库；
* **数据分析中心**：

  * FFQ 食物大类计算（单文件→xlsx）；
  * FFQ 营养素计算（单文件→xlsx）；
  * 24h 营养素计算（单文件→xlsx）；
  * 营养摄入评价（单文件→xlsx）；
  * PCA 饮食模式（单文件→xlsx）；
  * FFQ 信效度（单文件→xlsx）；
  * **DR-24 多文件合并**（多文件→ZIP，含日均/逐日/分日）；
  * **FFQ 多文件合并**（多文件→单一 xlsx）。
* **数据管理**：Flask-Admin 查看/筛选基础表；
* **可视化面板**：样本总数、高血压率等指标卡；
* **问卷**：`/survey/dr24`、`/survey/ffq` 以 iframe 方式加载离线页面；
* **SEO**：`/robots.txt` 与 `/sitemap.xml`；
* **前端主题**：紫黑星空+流光（已实现）。

### 4.2 Out of Scope（MVP 不做）

* 在线数据库问卷写回；
* 用户账号体系与权限精细化；
* 辅助诊断/个体化建议（V2+）。

## 5. 详细需求

### 5.1 页面与路由

* **首页** `/home`：模块卡片；星空动态背景；
* **数据分析** `/data_analysis`：

  * 表单 A（单文件）：`name="file"`；
  * 表单 B（多文件）：`name="files" multiple`；
  * **DR 合并选项**：`fixed_divisor_3`（复选框：是否固定除以 3；默认按有效天数求均值）；
  * 成功后重定向并展示“下载结果”按钮；
* **问卷**

  * DR-24：`/survey/dr24`（外壳） ↔ `/survey/dr24/raw`（原始离线页）；
  * Full-FFQ：`/survey/ffq` ↔ `/survey/ffq/raw`；
* **下载** `/download/<filetype>`：映射所有产出（xlsx/zip）。

### 5.2 服务端接口与处理

* **单文件分析**（POST `/data_analysis`）：

  * 参数：`analysis_type in {ffq, 24h, assessment, ffq_category, pca_pattern, validation_ffq, sum_dr_nutrients_for_web}`；
  * 入参校验：扩展名/大小/空文件；
  * 输出：保存至 `downloads/`，302 跳转带 `?done=...`。
* **多文件合并**（POST `/data_analysis`）：

  * `analysis_type in {concat_dr, ffq_merge}`；
  * `request.files.getlist('files')`；
  * **DR**：调用 `services/dr24_merge.process_dr_uploads_and_merge(files, fixed_divisor_3)` → 返回 ZIP（包含 3 个 xlsx）；
  * **FFQ**：调用 `services/ffq_merge.process_ffq_uploads_and_merge(files, header_row=2)` → 返回 xlsx；
* **SEO 路由**：`/robots.txt`、`/sitemap.xml` 自动生成核心链接。

### 5.3 关键算法口径（统一说明）

* **DR-24 合并**：同 ID 选“最新版本”（上传流无 mtime，用**文件名降序**打破并列）；在“最新版本”内部按 **ID×day×食物** 累加；
* **日均**：默认 **按有效天数平均**；若勾选 fixed_divisor_3，则固定除以 3；
* **FFQ 合并**：按 sheet=ID 的约定，频率×数量×单位→ g/天；**不清洗列名，不去除空白或括号内容**（精确对齐）。

### 5.4 输入/输出

* **输入**：Excel（`.xlsx/.xls/.xlsm`，FFQ/DR 建议 `.xlsx`）；
* **输出**：

  * DR：`DR24_合并结果.zip`（含：`三天24小时_日均宽表.xlsx`/`逐日宽表.xlsx`/`按天输出.xlsx`）；
  * FFQ：`FFQ_合并结果.xlsx`（单一 sheet=`FFQ_Merged`）。

### 5.5 UI/UX 要点

* 主题：紫黑+极光+星空；
* 卡片悬浮与霓虹描边；
* 错误反馈：表单顶部绿色/红色 Alert 提示；
* 无障碍：所有图标附带文本；
* 响应式：移动端一列、桌面端 3–4 列。

## 6. 数据与结构

### 6.1 目录

* `uploads/`（上传临时）、`downloads/`（导出）、`static/`（静态资源）、`templates/`（页面）。

### 6.2 表与文件（可选入库）

* `ffq`、`ffqnutrition`、`basicinformation`、`disease`（通过 SQLAlchemy automap 使用）。

## 7. 非功能需求（NFR）

* **性能**：参考 KPI；
* **安全**：仅研究用途，不收集身份证/手机号等强识别信息；下载链接带文件类型白名单；
* **隐私**：不记录个人隐私字段到日志；
* **容错**：单文件失败不影响整个批次（FFQ/DR 合并时跳过并记录原因）；
* **可维护**：服务模块化（`services/` 目录）。

## 8. 里程碑与排期

* **MVP（~2周）**

  * DR/FFQ 多文件合并打通；
  * 单文件分析 6 项稳定；
  * 下载路由、错误提示、基础 SEO；
* **V1.0（~4周）**

  * 可视化补全（Sankey/雷达/箱线/序列）；
  * 部署（Render）+ 自定义域名；
  * 监控日志与简易 Dashboard。

## 9. 验收标准（Sample）

* **用例：DR 合并（有效天数）**

  * 给定 10 份 DR `.xlsx`，其中 1 份 sheet 结构错误 → 系统提示并跳过；
  * 其余 9 份合并成功，生成 ZIP；
  * `日均宽表` 与 `逐日宽表` 行数=合并后 ID 数，`按天输出` 含 Day1/2/3；
* **用例：FFQ 合并（不清洗列名）**

  * 上传 5 份 FFQ（同一 ID 两个版本→取文件名更大的）；
  * 输出表包含 `ID`、`来源文件`、及所有出现过的**原始食物列名**；
  * 任一食物列为 g/天，空缺以 0 表示；
* **用例：失败回退**：上传非 Excel → 直接红色提示“文件类型不被允许”。

## 10. 指标与监控

* 服务器：请求数、5xx 比例、处理耗时；
* 应用：上传成功率、解析错误类型统计（文件/工作表/列缺失）；
* 产物：下载成功率、平均文件大小与生成耗时。

## 11. 风险与对策

* **Excel 异构严重**：增加列名模糊识别与错误报告（已在 `ffq_merge` 中实现列名自适应）；
* **大文件/多文件**：逐文件流式解析，限制并发与总大小（Nginx/Flask 配置）；
* **对外访问不稳定**：Render 选固定区域，前置静态落地页（Vercel/Netlify）。

## 12. 开放问题（需决策）

* 是否需要账号与权限（仅内部开放？）；
* 是否需要“任务队列”（Celery/RQ）做长任务后台执行；
* 是否需要将问卷数据直接写库（替换离线页）。

## 13. 附录

### 13.1 主要路由清单

* `GET /home` 主页
* `GET|POST /data_analysis` 数据分析中心
* `GET /download/<filetype>` 下载
* `GET /survey/dr24`、`/survey/dr24/raw`
* `GET /survey/ffq`、`/survey/ffq/raw`
* `GET /robots.txt`、`GET /sitemap.xml`

### 13.2 成功页面文案（模板）

> ✅ 分析完成，请 **点击下载结果**。

---

**执行建议（今天就能做）**

1. 把本 PRD 发仓库根目录 `/docs/PRD.md`；
2. 在 `data_analysis.html` 为 DR 与 FFQ 合并表单改为 `name="files" multiple`；
3. 打开 Render 一键部署（先 SQLite，后换 MySQL）；
4. 提交站点地图到 GSC/Bing/百度；
5. 下周做一次 10 份 DR 与 5 份 FFQ 的“验收实测”，按第 9 节打勾。
